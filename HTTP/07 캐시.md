# 07. 캐시

웹 캐시는 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치다.



## 7.1 불필요한 데이터 전송

을 줄인다.
불필요한 데이터 전송을 줄여서, 네트워크 요금으로 인한 비용을 줄여준다.

## 7.2 대역폭 병목

을 줄여준다. 대역폭을 늘리지 않고도 페이지를 빨리 불러 올 수 있게 된다.

## 7.3 갑작스런 요청 쇄도

에 대처하기 위해 특히나 중요하다. 예를들어, 특정 사건으로 인해 뉴스 사이트에 사용자가 몰리는 경우
원 서버에 대한 요청을 줄여준다. 서버는 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 된다.

## 7.4 거리로 인한 지연

을 줄여준다. 페이지를 먼 곳에서 불러올수록 시간이 많이 걸리는데, 캐시는 거리로 인한 지연을 줄여준다.

## 7.5 Cache hit과 miss (적중과 부적중)

캐시에 요청이 도착했을 때,

- 그에 대응하는 사본이 있음 -> Cache hit
- 대응하는 사본이 없이 원 서버로 전달됨 -> Cache miss

단, 원 서버 콘텐츠는 변경될 수 있기 때문에 캐시는 반드시 클라이언트에서 가지고 있는 사본이 최신버전인지 서버를 통해 확인해야 한다. (때때로)

![IMG_9585](/Users/mina/Downloads/IMG_9585.jpg)



## 7.6 캐시 토폴로지

캐시는 한 명의 사용자에게만 할당될 수 있고, 반대로 수천 명의 사용자들 간에 공유될 수도 있다. 

![IMG_9586](/Users/mina/Downloads/IMG_9586.jpg)

![IMG_9587](/Users/mina/Downloads/IMG_9587.jpg)

## 7.7 캐시 처리 단계

![IMG_9588](/Users/mina/Downloads/IMG_9588.jpg)

1. 요청 받기

   캐시는 네트워크로부터 도착한 요청 메시지를 읽는다.

2. 파싱

   캐시는 메시지를 파싱하여 URL과 헤더들을 추출한다.

3. 검색

   캐시는 로컬 복사본이 있는지 검사하고, 사본이 없다면 사본을 받아온다 (그리고 로컬에 저장한다)

4. 신선도 검사

   캐시는 캐시에 사본이 충분히 신선한지 검사하고, 신헌하지 않다면 변경사항이 있는지 서버에게 물어본다.

5. 응답 생성

   캐시는 새로운 헤더와 캐시된 본문으로 응답 메시지를 만든다.

6. 발송

   캐시는 네트워크를 통해 응답을 클라이언트에게 돌려준다.

7. 로깅

   선택적으로, 캐시는 로그파일에 트랜잭선에 대해 서술한 로그 하나를 남긴다.

![IMG_9589](/Users/mina/Downloads/IMG_9589.jpg)

## 7.8 사본을 신선하게 유지하기

HTTP는 어떤 캐시가 사본을 갖고 있는지 서버가 기억하지 않더라도, 캐시된 사본이 서버와 충분히 일치하도록 유지할 수 있게 해주는 단순한 메커니즘(문서 만료, 서버 재검사)을 갖고 있다.

1. 문서 만료

2. 유효기간과 나이

   서버는 응답 본문과 함께 하는, HTTP/1.0+ Expires나 HTTP/1.1 Cache-Control: max-age 응답 헤더를 이용해서 유효기간을 명시한다. 

3. 서버 재검사

   캐시된 문서가 만료되었다는 것은 검사할 시간이 되었음을 뜻한다.

## 7.9 캐시 제어

HTTP는 문서가 만료되기 전까지 얼마나 오랫동안 캐시될 수 있게 할 것인지 서버가 설정할 수 있는 여러 가지 방법을 정의한다.

- Cache-Control: no-store -> 캐시가 응답의 사본을 만드는 것을 금지한다. 객체 삭제
- Cache-Control: no-cache -> 로컬 캐시 저장소에 저장될 수 있지만, 먼저 서버와 재검사를 하지 않고서는 캐시에서 클라이언트로 제공될 수 없을 뿐이다. 
- Cache-Control: must-revalidate -> 캐시가 이 객체의 신선하지 않은 사본을 원 서버와의 최초의 재검사 없이는 제공해서 안됨을 의미한다.
- Cache-Control: max-age=3600 -> 신선하다고 간주되었던 문서가 서버로부터 온 이후로 흐른 시간이고, 초로 나타낸다.  



## 7.12 캐시와 광고

1. 광고 회사의 딜레마

캐시를 하면 원 서버에 요청이 줄기 때문에 광고가 노출되지 않는다.

2. 퍼블리셔의 응답

광고 회사는 캐시를 무력화 하는 방법을 사용한다. 프락시 캐시 입장에선 자신의 역할을 못하기 때문에 이런 무력화를 막기도 한다. 그런데 또 캐시를 하면 방문자 통계를 알 수 없게 한다. 이를 해결하는 대표적인 방법으로는 요청은 원서버에 가지만 본문은 전송하지 않는 식이다.

3. 로그 마이그레이션

캐시의 로그를 통해 원서버로의 요청을 뽑아 내려고 하지만, 인증이나 여러 이슈 때문에 표준화 되지 않았다고 한다.

4. 적중 측정과 사용량 제한

특정 URL에 대한 캐시 적중 횟수를 Meter라는 새 헤더 하나를 추가해서 넣는데, 이 방법을 Simple Hit-Metering and Usage-Limiting for HTTP라 한다. 이 값을 보고 캐시가 몇번이나 문서를 제공할 수 있는지 제한할 수 있다.







